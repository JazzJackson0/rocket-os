<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8>
    <title>Rocket vis</title>
    <style>
      body, html, canvas
      {
          margin: 0; padding: 0; box-sizing: border-box;
          width: 100%; height: 100%;
      }
    </style>
  </head>
  <body>
  </body>
</html>

<script src="scripts/three.js"></script>
<script>

var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

var renderer = new THREE.WebGLRenderer();
renderer.setSize( window.innerWidth - 50, window.innerHeight - 50);
document.body.appendChild( renderer.domElement );

var geometry = new THREE.BoxGeometry( 1, 1, 5 );
var material = new THREE.MeshStandardMaterial( { color: 0xdddddd } );
var cube = new THREE.Mesh( geometry, material );
scene.add( cube );

var light = new THREE.HemisphereLight( 0xffffbb, 0x080820, 1 );
scene.add( light );

let euler = new THREE.Euler(0, 0, 0, "XYZ");

camera.position.z = 5;

function animate()
{
    requestAnimationFrame( animate );
    renderer.render( scene, camera );
    cube.rotation.x = euler.x;
    cube.rotation.y = euler.y;
    cube.rotation.z = euler.z;
}
animate();

function onRecieveData(data)
{
    let qdata = data["/sensors/imu/orientation"];
    let quat = new THREE.Quaternion(qdata.x, qdata.y, qdata.z, qdata.w);
    quat.normalize();
    euler.setFromQuaternion(quat, "XYZ");
}

const update_frequency = 10; // hz
const update_period = 1/update_frequency; // seconds
const update_loop = window.setInterval(function()
{
    let req = new XMLHttpRequest();
    req.onload = function(e)
    {
        let data = JSON.parse(e.target.response);
        for (let key in data)
            data[key] = JSON.parse(data[key]);
        onRecieveData(data);
    };
    req.open('POST', '/update', true);
    req.send();
},
update_period*1000);

</script>
